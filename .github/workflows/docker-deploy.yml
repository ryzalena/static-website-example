name: Deploy to Server

on:
  # Запускаем после успешной сборки
  workflow_run:
    workflows: ["Docker Build and Push"]
    types: [completed]

jobs:
  deploy:
    # Запускаем только если сборка УСПЕШНА
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Deploy to server
      run: |
        ssh -o StrictHostKeyChecking=no \
            -p 2200 \
            ryzhova@course.prafdin.ru '
        
        # Останавливаем старый контейнер
        docker stop website-container 2>/dev/null || true
        docker rm website-container 2>/dev/null || true
        
        # Логинимся в GitHub Container Registry
        echo "${{ secrets.GITHUB_TOKEN }}" | \
          docker login ghcr.io -u ${{ github.actor }} --password-stdin
        
        # Скачиваем и запускаем новый контейнер
        docker pull ghcr.io/ryzalena/static-website-example:labs3
        docker run -d \
          --name website-container \
          --restart unless-stopped \
          -p 80:80 \
          ghcr.io/ryzalena/static-website-example:labs3
        
        echo "✅ Container started!"
        '
