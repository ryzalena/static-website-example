name: Docker Deploy to Production

on:
  # 1. ÐŸÐ¾ÑÐ»Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð¹ ÑÐ±Ð¾Ñ€ÐºÐ¸
  workflow_run:
    workflows: ["Docker Build and Push"]
    types: [completed]
  
  # 2. ÐŸÑ€Ð¸ Ñ€ÐµÐ»Ð¸Ð·Ðµ
  release:
    types: [published]
  
  # 3. Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº
  workflow_dispatch:

jobs:
  deploy:
    # Ð£ÑÐ»Ð¾Ð²Ð¸Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ°
    if: |
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
      github.event_name == 'release' ||
      github.event_name == 'workflow_dispatch'
    
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
    - name: Add host to known_hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -p 2200 course.prafdin.ru >> ~/.ssh/known_hosts
        chmod 644 ~/.ssh/known_hosts
    
    - name: ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ñ‚ÐµÐ³ Ð¾Ð±Ñ€Ð°Ð·Ð°
      id: tag
      run: |
        if [ "${{ github.event_name }}" = "release" ]; then
          echo "tag=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          echo "message=ðŸš€ Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ñ€ÐµÐ»Ð¸Ð·Ð° ${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
        elif [ "${{ github.event_name }}" = "workflow_run" ]; then
          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ñ‚ÐµÐ³ Ð¸Ð· workflow run
          RUN_ID=${{ github.event.workflow_run.id }}
          # Ð”Ð»Ñ Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ñ‚Ñ‹ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ labs3
          echo "tag=labs3" >> $GITHUB_OUTPUT
          echo "message=ðŸ“¦ Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð²ÐµÑ‚ÐºÐ¸ labs3" >> $GITHUB_OUTPUT
        else
          echo "tag=labs3" >> $GITHUB_OUTPUT
          echo "message=ðŸ› ï¸ Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð´ÐµÐ¿Ð»Ð¾Ð¹" >> $GITHUB_OUTPUT
        fi
        
        echo "Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ñ‚ÐµÐ³: ${{ steps.tag.outputs.tag }}"
    
    - name: Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€
      run: |
        echo "${{ steps.tag.outputs.message }}"
        
        IMAGE_NAME="ghcr.io/ryzalena/static-website-example:${{ steps.tag.outputs.tag }}"
        
        ssh -o StrictHostKeyChecking=no -p 2200 styzhev@course.prafdin.ru "
          echo '=== ÐÐ°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ Ð´ÐµÐ¿Ð»Ð¾Ð¹ ==='
          echo 'ÐžÐ±Ñ€Ð°Ð·: $IMAGE_NAME'
          echo ''
          
          # 1. Ð›Ð¾Ð³Ð¸Ð½Ð¸Ð¼ÑÑ Ð² registry
          echo 'ðŸ” Ð›Ð¾Ð³Ð¸Ð½ Ð² GitHub Container Registry...'
          echo '${{ secrets.GITHUB_TOKEN }}' | docker login ghcr.io -u 'ryzalena' --password-stdin
          
          # 2. ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ð¹ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€
          echo 'ðŸ›‘ ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ð¹ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€...'
          docker stop website 2>/dev/null || true
          docker rm website 2>/dev/null || true
          
          # 3. ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ ÑÐºÐ°Ñ‡Ð°Ñ‚ÑŒ ÑƒÐºÐ°Ð·Ð°Ð½Ð½Ñ‹Ð¹ Ñ‚ÐµÐ³
          echo 'ðŸ“¥ Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Docker Ð¾Ð±Ñ€Ð°Ð·...'
          if docker pull \"$IMAGE_NAME\"; then
            echo 'âœ… ÐžÐ±Ñ€Ð°Ð· Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½'
          else
            echo 'âš ï¸  ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ $IMAGE_NAME'
            echo 'ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ Ñ‚ÐµÐ³ labs3...'
            docker pull ghcr.io/ryzalena/static-website-example:labs3
            IMAGE_NAME='ghcr.io/ryzalena/static-website-example:labs3'
          fi
          
          # 4. Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€
          echo 'â–¶ï¸  Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€...'
          docker run -d \\
            --name website \\
            --restart unless-stopped \\
            -p 8081:80 \\
            -e \"VERSION=${{ steps.tag.outputs.tag }}\" \\
            -e \"DEPLOY_TIME=\$(date)\" \\
            \"\$IMAGE_NAME\"
          
          # 5. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼
          sleep 3
          echo ''
          echo 'ðŸ“Š Ð¡Ñ‚Ð°Ñ‚ÑƒÑ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð°:'
          docker ps --filter \"name=website\" --format \"table {{.Names}}\\t{{.Status}}\\t{{.Ports}}\\t{{.Image}}\"
          
          # 6. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚ÑŒ
          echo ''
          echo 'ðŸŒ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚ÑŒ...'
          if curl -s -f http://localhost:80 > /dev/null; then
            echo 'âœ… ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚!'
            echo ''
            echo 'ðŸŽ‰ Ð”Ð•ÐŸÐ›ÐžÐ™ Ð£Ð¡ÐŸÐ•Ð¨Ð•Ð!'
            echo 'ðŸŒ Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ Ð¿Ð¾ Ð°Ð´Ñ€ÐµÑÑƒ:'
            echo '   http://app.ryzhova.course.prafdin.ru'
          else
            echo 'âŒ ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð½Ðµ Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÐµÑ‚'
            docker logs website
            exit 1
          fi
        "
    
    - name: Ð¡Ð²Ð¾Ð´ÐºÐ° Ð´ÐµÐ¿Ð»Ð¾Ñ
      run: |
        echo "## ðŸ“‹ Ð˜Ñ‚Ð¾Ð³ Ð´ÐµÐ¿Ð»Ð¾Ñ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Ð¡Ñ‚Ð°Ñ‚ÑƒÑ:** âœ… Ð£ÑÐ¿ÐµÑˆÐ½Ð¾" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Ð”ÐµÑ‚Ð°Ð»Ð¸:**" >> $GITHUB_STEP_SUMMARY
        echo "- Ð¢ÐµÐ³ Ð¾Ð±Ñ€Ð°Ð·Ð°: \`${{ steps.tag.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- Ð¡ÐµÑ€Ð²ÐµÑ€: \`course.prafdin.ru:2200\`" >> $GITHUB_STEP_SUMMARY
        echo "- ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ: \`styzhev\`" >> $GITHUB_STEP_SUMMARY
        echo "- URL Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ: [http://app.ryzhova.course.prafdin.ru](http://app.ryzhova.course.prafdin.ru)" >> $GITHUB_STEP_SUMMARY
        echo "- Ð’Ñ€ÐµÐ¼Ñ: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ñ€Ð°Ð·Ð²ÐµÑ€Ð½ÑƒÑ‚Ð¾!" >> $GITHUB_STEP_SUMMARY
