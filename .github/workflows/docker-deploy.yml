name: Deploy on Release or Push

on:
  # –ü—Ä–∏ —Ä–µ–ª–∏–∑–µ
  release:
    types: [published]
  
  # –ü—Ä–∏ –ø—É—à –≤ labs3
  push:
    branches: [labs3]
  
  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Determine deployment type
      id: deploy-info
      run: |
        if [ "${{ github.event_name }}" = "release" ]; then
          echo "type=release" >> $GITHUB_OUTPUT
          echo "tag=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          echo "message=üöÄ Deploying release: ${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
        else
          echo "type=push" >> $GITHUB_OUTPUT
          echo "tag=labs3" >> $GITHUB_OUTPUT
          echo "message=üì¶ Deploying latest labs3 branch" >> $GITHUB_OUTPUT
        fi

    - name: Deploy to server
      run: |
        echo "${{ steps.deploy-info.outputs.message }}"
        
        ssh -p 2200 ryzhova@course.prafdin.ru "
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–±—Ä–∞–∑
          if [ '${{ steps.deploy-info.outputs.type }}' = 'release' ]; then
            IMAGE_TAG='${{ github.event.release.tag_name }}'
          else
            IMAGE_TAG='labs3'
          fi
          
          echo 'Using image tag: \$IMAGE_TAG'
          
          # –õ–æ–≥–∏–Ω –≤ registry
          echo '${{ secrets.GITHUB_TOKEN }}' | docker login ghcr.io -u '${{ github.actor }}' --password-stdin
          
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
          docker stop website 2>/dev/null || true
          docker rm website 2>/dev/null || true
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π
          docker pull ghcr.io/ryzalena/static-website-example:\$IMAGE_TAG
          docker run -d --name website -p 80:80 \
            ghcr.io/ryzalena/static-website-example:\$IMAGE_TAG
            
          echo '‚úÖ Deployment complete!'
        "
