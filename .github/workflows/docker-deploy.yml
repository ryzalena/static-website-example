name: Deploy on Release or Push

on:
  push:
    branches: [labs3]
  
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
    - name: Add host to known_hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -p 2200 course.prafdin.ru >> ~/.ssh/known_hosts
        chmod 644 ~/.ssh/known_hosts
        echo "‚úÖ Host added to known_hosts"
    
    - name: Deploy to server
      run: |
        echo "üì¶ Deploying latest labs3 branch"
        
        # –ü—Ä–æ—Å—Ç–æ–π –¥–µ–ø–ª–æ–π
        ssh -o StrictHostKeyChecking=no -p 2200 styzhev@course.prafdin.ru "
          # 1. –õ–æ–≥–∏–Ω –≤ registry
          echo '${{ secrets.GITHUB_TOKEN }}' | docker login ghcr.io -u 'ryzalena' --password-stdin
          
          # 2. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
          docker stop website 2>/dev/null || true
          docker rm website 2>/dev/null || true
          
          # 3. –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π
          docker pull ghcr.io/ryzalena/static-website-example:labs3
          docker run -d --name website -p 80:80 \\
            ghcr.io/ryzalena/static-website-example:labs3
            
          echo '‚úÖ Deployment complete!'
          echo 'üåê App available at: http://app.ryzhova.course.prafdin.ru'
        "
