name: CD Deploy with Docker

on:
  # –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π —Å–±–æ—Ä–∫–∏ –∏–ª–∏ –ø—Ä–∏ —Ä–µ–ª–∏–∑–µ
  workflow_run:
    workflows: ["Docker Build and Push"]
    types: [completed]
    branches: [labs3]
  
  # –ò–ª–∏ —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
  workflow_dispatch:

jobs:
  deploy:
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–∞
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: labs3

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Deploy to VM via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: course.prafdin.ru
        username: ryzhova
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 2200
        script: |
          # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Docker –¥–µ–ø–ª–æ—è
          CONTAINER_NAME="website-container"
          IMAGE_NAME="ghcr.io/ryzalena/static-website-example:labs3"
          LOG_FILE="/home/ryzhova/deploy-docker.log"
          APP_URL="http://app.ryzhova.course.prafdin.ru"
          
          # –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
          log() {
              echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a $LOG_FILE
          }
          
          log "üöÄ –ó–ê–ü–£–°–ö–ê–ï–ú –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ï –ß–ï–†–ï–ó DOCKER (CD):"
          log "   –í–µ—Ç–∫–∞: labs3"
          log "   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ryzhova"
          log "   –•–æ—Å—Ç: course.prafdin.ru:2200"
          
          # 1. –õ–æ–≥–∏–Ω–∏–º—Å—è –≤ registry
          log "   - –õ–æ–≥–∏–Ω–∏–º—Å—è –≤ GitHub Container Registry..."
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          # 2. Pull latest Docker image –∏–∑ registry
          log "   - –ó–∞–≥—Ä—É–∂–∞–µ–º Docker –æ–±—Ä–∞–∑..."
          if docker pull $IMAGE_NAME; then
              log "   ‚úÖ Docker –æ–±—Ä–∞–∑ –∑–∞–≥—Ä—É–∂–µ–Ω"
          else
              log "   ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ Docker –æ–±—Ä–∞–∑–∞"
              exit 1
          fi
          
          # 3. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
          log "   - –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä..."
          docker stop $CONTAINER_NAME 2>/dev/null || true
          docker rm $CONTAINER_NAME 2>/dev/null || true
          
          # 4. –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
          log "   - –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä..."
          if docker run -d \
            --name $CONTAINER_NAME \
            --restart unless-stopped \
            -p 80:80 \
            $IMAGE_NAME; then
              log "   ‚úÖ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω"
          else
              log "   ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞"
              exit 1
          fi
          
          # 5. –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –∑–∞–ø—É—Å–∫
          sleep 5
          
          # 6. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
          log "   - –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
          if docker ps | grep -q $CONTAINER_NAME; then
              log "   ‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä $CONTAINER_NAME –∞–∫—Ç–∏–≤–µ–Ω"
          else
              log "   ‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è"
              docker logs $CONTAINER_NAME
              exit 1
          fi
          
          # 7. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ä—Ç
          log "   - –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ä—Ç 80..."
          if docker port $CONTAINER_NAME | grep -q "80"; then
              log "   ‚úÖ –ü–æ—Ä—Ç 80 –ø—Ä–æ–±—Ä–æ—à–µ–Ω"
          else
              log "   ‚ùå –ü–æ—Ä—Ç 80 –Ω–µ –ø—Ä–æ–±—Ä–æ—à–µ–Ω"
              exit 1
          fi
          
          # 8. –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
          log "   - –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
          if docker exec $CONTAINER_NAME curl -f http://localhost:80 > /dev/null 2>&1; then
              log "   ‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ HTTP –∑–∞–ø—Ä–æ—Å—ã –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞"
          else
              log "   ‚ùå –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞"
              docker logs $CONTAINER_NAME
              exit 1
          fi
          
          # 9. –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–Ω–∞—Ä—É–∂–∏
          log "   - –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–Ω–µ—à–Ω—é—é –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å..."
          sleep 3
          if curl -f http://localhost:80 > /dev/null 2>&1; then
              log "   ‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ —Å–Ω–∞—Ä—É–∂–∏"
              log "   üéâ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ï –ß–ï–†–ï–ó DOCKER –£–°–ü–ï–®–ù–û!"
              log "   üåê –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ: $APP_URL"
          else
              log "   ‚ö†Ô∏è  –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–∞, –Ω–æ –≤–Ω–µ—à–Ω—è—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞"
              log "   ‚ÑπÔ∏è  –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:"
              log "      - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ nginx –Ω–∞ —Ö–æ—Å—Ç–µ"
              log "      - –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø–æ—Ä—Ç–∞ 80"
              log "      - –ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ $APP_URL"
          fi
          
          # 10. –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –æ–±—Ä–∞–∑–æ–≤
          log "   - –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ Docker –æ–±—Ä–∞–∑—ã..."
          docker image prune -f 2>/dev/null || true
          log "   ‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
          
          # 11. –§–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
          log ""
          log "üìä –ò–¢–û–ì–û–í–´–ô –°–¢–ê–¢–£–°:"
          docker ps --filter "name=$CONTAINER_NAME" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}\t{{.Image}}"
          log ""
          log "üìã –õ–û–ì–ò –ö–û–ù–¢–ï–ô–ù–ï–†–ê (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å—Ç—Ä–æ–∫):"
          docker logs --tail 10 $CONTAINER_NAME

    - name: Verify deployment success
      run: |
        echo "‚úÖ –î–µ–ø–ª–æ–π –≤—ã–ø–æ–ª–Ω–µ–Ω"
        echo "üåê –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É:"
        echo "   http://app.ryzhova.course.prafdin.ru"
        echo ""
        echo "üìã –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:"
        echo "   curl -I http://app.ryzhova.course.prafdin.ru"
