name: CI - Build Static Site Image

on:
  push:
    branches: [ lab4 ]

jobs:
  build-web-image:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create necessary files
        run: |
          echo "üìù –°–æ–∑–¥–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ñ–∞–π–ª—ã..."
          
          # 1. Dockerfile –¥–ª—è –≤–µ–±-—Å–∞–π—Ç–∞
          cat > Dockerfile << 'EOF'
          FROM nginx:alpine
            COPY public /usr/share/nginx/html
          EOF
          
          # 2. –ü–∞–ø–∫–∞ public –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
          mkdir -p public
          
          # 3. index.html –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
          if [ ! -f "public/index.html" ]; then
            cat > public/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>Static Site - Lab 4</title>
          </head>
          <body>
              <h1>Docker Compose Lab</h1>
              <p>CI/CD Pipeline</p>
          </body>
          </html>
          EOF
          fi
          
          echo "‚úÖ –§–∞–π–ª—ã —Å–æ–∑–¥–∞–Ω—ã"

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push web image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ghcr.io/ryzalena/static-site-lab4:latest
          labels: |
            org.opencontainers.image.source=https://github.com/ryzalena/static-website-example
