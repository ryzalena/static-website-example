name: CD Pipeline - Full Deploy

on:
  push:
    branches: [ main, github-actions ]
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Show repository structure
      run: |
        echo "üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è:"
        find . -type f -name "*.html" -o -name "*.css" -o -name "*.js" | head -30
        
        echo ""
        echo "üìÑ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ index.html:"
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        if [ -f "index.html" ]; then
          cat index.html
        else
          echo "index.html –Ω–µ –Ω–∞–π–¥–µ–Ω"
          # –ò—â–µ–º HTML —Ñ–∞–π–ª—ã
          HTML_FILES=$(find . -name "*.html" -type f | head -5)
          if [ -n "$HTML_FILES" ]; then
            echo "–ù–∞–π–¥–µ–Ω—ã –¥—Ä—É–≥–∏–µ HTML —Ñ–∞–π–ª—ã:"
            for file in $HTML_FILES; do
              echo "üìÅ $file"
            done
          fi
        fi
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    
    - name: Copy all files to VM
      uses: appleboy/scp-action@v0.1.7
      with:
        host: course.prafdin.ru
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 2200
        source: "*"
        target: "~/app/"
        strip_components: 0
    
    - name: Deploy and restart server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: course.prafdin.ru
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 2200
        script: |
          echo "üîÑ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞..."
          pkill -f "http.server 8181" 2>/dev/null || echo "–°–µ—Ä–≤–µ—Ä –Ω–µ –±—ã–ª –∑–∞–ø—É—â–µ–Ω"
          
          echo "üìÅ –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
          cd ~/app
          
          echo "üìä –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:"
          ls -la
          
          echo ""
          echo "üìÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ index.html:"
          if [ -f "index.html" ]; then
            echo "‚úÖ index.html –Ω–∞–π–¥–µ–Ω"
            echo "–ü–µ—Ä–≤—ã–µ 10 —Å—Ç—Ä–æ–∫ —Ñ–∞–π–ª–∞:"
            head -10 index.html
          else
            echo "‚ùå index.html –Ω–µ –Ω–∞–π–¥–µ–Ω!"
            echo "–°–æ–∑–¥–∞—é –ø—Ä–æ—Å—Ç–æ–π index.html..."
            echo '<!DOCTYPE html>
<html>
<head>
    <title>Deployed via GitHub Actions</title>
</head>
<body>
    <h1>Deployed via GitHub Actions</h1>
    <p>Time: $(date)</p>
    <p>Commit: ${{ github.sha }}</p>
</body>
</html>' > index.html
          fi
          
          echo ""
          echo "üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –ø–æ—Ä—Ç—É 8181..."
          python3 -m http.server 8181 --bind 0.0.0.0 > server.log 2>&1 &
          
          echo "‚úÖ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω!"
          echo "üîó –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ: http://app.ryzhova.course.prafdin.ru"
          echo "üìù –õ–æ–≥ —Å–µ—Ä–≤–µ—Ä–∞: ~/app/server.log"
