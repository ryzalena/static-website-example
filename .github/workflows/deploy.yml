name: CD Pipeline - Deploy to VM

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Deploy to VM
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: course.prafdin.ru
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 2200
        script_stop: true
        script: |
          set -e
          echo "Деплой приложения..."
          
          APP_DIR="$HOME/app"
          mkdir -p "$APP_DIR"
          cd "$APP_DIR"
          
          # Используем порт 8282 вместо 8181 (если 8181 занят FRP)
          APP_PORT=8282
          FRP_PORT=8181  # Порт который пробрасывает FRP
          
          echo "Используемый порт приложения: $APP_PORT"
          echo "Порт FRP: $FRP_PORT"
          
          # Останавливаем старое приложение
          pkill -f "python3.*app.py" 2>/dev/null || true
          sudo fuser -k $APP_PORT/tcp 2>/dev/null || true
          sleep 2
          
          # Создаем приложение
          cat > app.py << EOF
from flask import Flask
import time

app = Flask(__name__)

@app.route('/')
def index():
    return 'GitHub Actions CD - Лабораторная работа 2<br>Порт: $APP_PORT'

@app.route('/health')
def health():
    return 'OK', 200

if __name__ == '__main__':
    print(f"Запуск на порту {APP_PORT}")
    app.run(host='0.0.0.0', port=APP_PORT, debug=False)
EOF
          
          # Устанавливаем Flask
          pip3 install --break-system-packages flask
          
          # Запускаем
          nohup python3 app.py > app.log 2>&1 &
          echo $! > app.pid
          
          sleep 3
          
          # Проверяем
          if curl -s http://localhost:$APP_PORT > /dev/null; then
            echo "Приложение запущено на порту $APP_PORT"
            echo "FRP должен пробрасывать порт $FRP_PORT на $APP_PORT"
          else
            echo "Ошибка запуска"
            cat app.log
            exit 1
          fi
          
          echo "Проверьте: http://app.ryzhova.course.prafdin.ru"
