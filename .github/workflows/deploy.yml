name: CD Pipeline - Deploy Static Site

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Deploy to VM
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: course.prafdin.ru
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 2200
        script_stop: true
        script: |
          set -e
          echo "Деплой статического сайта..."
          
          # Подготовка директории
          APP_DIR="$HOME/app"
          echo "Рабочая директория: $APP_DIR"
          mkdir -p "$APP_DIR"
          cd "$APP_DIR"
          
          # Остановка старого приложения
          echo "Остановка предыдущего приложения..."
          pkill -f "python3.*app.py" 2>/dev/null || true
          sleep 2
          
          # Копирование файлов (в реальности нужно scp-action, но для простоты создадим здесь)
          echo "Создание файлов приложения..."
          
          # Создаем app.py
          cat > app.py << 'EOF'
from flask import Flask, send_from_directory
import os

app = Flask(__name__)
BASE_DIR = os.path.dirname(os.path.abspath(__file__))

@app.route('/')
def index():
    return send_from_directory(BASE_DIR, 'index.html')

@app.route('/health')
def health():
    return 'OK', 200

if __name__ == '__main__':
    print("Запуск Flask сервера на порту 8181")
    app.run(host='0.0.0.0', port=8181, debug=False)
EOF
          
          # Создаем index.html
          cat > index.html << 'EOF'
<!DOCTYPE html>
<html>
<head>
    <title>My Static Site</title>
    <style>
        body { 
            background-color: blue; 
            color: white; 
            text-align: center; 
            padding: 50px; 
            font-family: Arial, sans-serif;
        }
        h1 { color: yellow; }
        .info { 
            background: darkblue; 
            padding: 15px; 
            margin: 20px auto; 
            border-radius: 10px;
            max-width: 600px;
        }
    </style>
</head>
<body>
    <h1>Hello from GitHub Actions!</h1>
    <p>Deployed automatically via CI/CD pipeline</p>
    
    <div class="info">
        <p><strong>Student:</strong> Ryzhova</p>
        <p><strong>Lab:</strong> DevOps Lab 2 - GitHub Actions</p>
        <p><strong>Domain:</strong> app.ryzhova.course.prafdin.ru</p>
    </div>
    
    <p>This HTML file is served by Flask from a separate file</p>
</body>
</html>
EOF
          
          # Создаем requirements.txt
          echo "Flask==2.3.3" > requirements.txt
          
          echo "Файлы созданы:"
          ls -la
          
          # Установка зависимостей
          echo "Установка Flask..."
          pip3 install --break-system-packages flask
          
          # Запуск приложения
          echo "Запуск сервера..."
          nohup python3 app.py > app.log 2>&1 &
          APP_PID=$!
          echo $APP_PID > app.pid
          
          sleep 5
          
          # Проверка
          if ps -p $APP_PID > /dev/null; then
            echo "Сервер запущен (PID: $APP_PID)"
            echo "Логи:"
            tail -5 app.log
            
            echo "Проверка локально..."
            if curl -s -f http://localhost:8181 > /dev/null; then
              echo "Локальная проверка успешна"
              echo "Содержимое:"
              curl -s http://localhost:8181 | head -10
            fi
          else
            echo "Ошибка запуска"
            cat app.log
            exit 1
          fi
          
          echo "Сайт доступен по: http://app.ryzhova.course.prafdin.ru"
          echo "Деплой завершен"
