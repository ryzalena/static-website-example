script: |
  echo "Начало деплоя приложения..."
  
  # Определяем домашнюю директорию
  USER_HOME="/home/$USER"
  APP_DIR="$USER_HOME/app"
  
  echo "Директория приложения: $APP_DIR"
  
  # Создаем директорию если не существует
  if [ ! -d "$APP_DIR" ]; then
    echo "Создаем директорию приложения..."
    mkdir -p "$APP_DIR"
  fi
  
  cd "$APP_DIR"
  echo "Текущая директория: $(pwd)"
  
  # Останавливаем текущее приложение если запущено
  if [ -f app.pid ]; then
    echo "Останавливаем текущее приложение..."
    kill $(cat app.pid) 2>/dev/null || true
    rm -f app.pid
  fi
  
  # Проверяем наличие app.py
  if [ ! -f "app.py" ]; then
    echo "app.py не найден, создаем минимальное приложение..."
    cat > app.py << 'EOF'
from flask import Flask
app = Flask(__name__)

@app.route('/')
def hello():
    return 'Приложение развернуто через GitHub Actions CD!'

@app.route('/health')
def health():
    return 'OK', 200

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=8181, debug=False)
EOF
  fi
  
  # Создаем requirements.txt если нет
  if [ ! -f "requirements.txt" ]; then
    echo "Создаем requirements.txt..."
    echo "Flask==2.3.3" > requirements.txt
  fi
  
  # Устанавливаем зависимости с флагом для новой Ubuntu
  echo "Устанавливаем зависимости Python..."
  pip3 install --break-system-packages -r requirements.txt
  
  # Запускаем приложение
  echo "Запускаем приложение..."
  nohup python3 app.py > app.log 2>&1 &
  echo $! > app.pid
  
  # Проверяем что приложение запустилось
  sleep 3
  if ps -p $(cat app.pid) > /dev/null; then
    echo "Приложение успешно запущено (PID: $(cat app.pid))"
    echo "Логи приложения:"
    tail -5 app.log
  else
    echo "Ошибка: приложение не запустилось"
    echo "Последние логи:"
    tail -20 app.log
    exit 1
  fi
  
  # Проверяем доступность приложения
  echo "Проверяем доступность приложения..."
  APP_URL="http://app.ryzhova.course.prafdin.ru"
  echo "URL приложения: $APP_URL"
  
  if curl -s -f --max-time 10 "$APP_URL" > /dev/null; then
    echo "Приложение доступно по адресу: $APP_URL"
    echo "Содержимое:"
    curl -s "$APP_URL"
  else
    echo "Предупреждение: не удалось подключиться к $APP_URL"
    echo "Приложение может быть запущено, но недоступно через прокси"
  fi
  
  echo "Деплой успешно завершен!"
