name: Deploy with Docker Compose

# ÐšÐ¾Ð³Ð´Ð° Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ð¿Ð°Ð¹Ð¿Ð»Ð°Ð¹Ð½
on:
  push:
    branches: [ main, lab4 ]  # ÐŸÑ€Ð¸ Ð¿ÑƒÑˆÐµ Ð² ÑÑ‚Ð¸ Ð²ÐµÑ‚ÐºÐ¸
  pull_request:
    branches: [ main, lab4 ]  # Ð˜ Ð¿Ñ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸ PR
  workflow_dispatch:          # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº

# ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Job 1: Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¸ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    # Ð¨Ð°Ð³ 1: ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÐºÐ¾Ð´
    - name: Checkout repository
      uses: actions/checkout@v4
      
    # Ð¨Ð°Ð³ 2: ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Docker Compose Ñ„Ð°Ð¹Ð»
    - name: Validate docker-compose.yml
      run: |
        echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° docker-compose.yaml..."
        docker compose config
        
    # Ð¨Ð°Ð³ 3: ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Ñ„Ð°Ð¹Ð»Ð¾Ð²
    - name: Check project structure
      run: |
        echo "Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°:"
        find . -type f -name "*.yaml" -o -name "*.yml" -o -name "*.html" -o -name "*.css" | sort
        echo ""
        echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²:"
        [ -f "docker-compose.yaml" ] && echo "âœ“ docker-compose.yaml Ð½Ð°Ð¹Ð´ÐµÐ½" || echo "âœ— docker-compose.yaml Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚"
        [ -d "public" ] && echo "âœ“ ÐŸÐ°Ð¿ÐºÐ° public Ð½Ð°Ð¹Ð´ÐµÐ½Ð°" || echo "âœ— ÐŸÐ°Ð¿ÐºÐ° public Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚"
        [ -f "public/index.html" ] && echo "âœ“ index.html Ð½Ð°Ð¹Ð´ÐµÐ½" || echo "âœ— index.html Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚"
        
    # Ð¨Ð°Ð³ 4: Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Docker Compose (Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ð·Ð°Ð¿ÑƒÑÐº)
    - name: Test Docker Compose
      run: |
        echo "Ð¢ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ð·Ð°Ð¿ÑƒÑÐº Docker Compose..."
        docker compose up -d
        sleep 10
        
        echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð½Ñ‹Ñ… ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²:"
        docker compose ps
        
        echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚Ð¸ ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²:"
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð²ÐµÐ±-ÑÐµÑ€Ð²ÐµÑ€
        timeout 10s bash -c 'until curl -f http://localhost:8088; do sleep 1; done' && echo "âœ“ Ð’ÐµÐ±-ÑÐµÑ€Ð²ÐµÑ€ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½"
        
        # ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹
        docker compose down
        
  # Job 2: Ð”ÐµÐ¿Ð»Ð¾Ð¹ (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ ÐºÑƒÐ´Ð° Ð´ÐµÐ¿Ð»Ð¾Ð¸Ñ‚ÑŒ)
  deploy:
    needs: build-and-test  # Ð—Ð°Ð²Ð¸ÑÐ¸Ñ‚ Ð¾Ñ‚ ÑƒÑÐ¿ÐµÑ…Ð° ÑÐ±Ð¾Ñ€ÐºÐ¸
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/lab4'  # Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ main/lab4 Ð²ÐµÑ‚Ð¾Ðº
    
    steps:
    # Ð¨Ð°Ð³ 1: ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÐºÐ¾Ð´
    - name: Checkout code
      uses: actions/checkout@v4
      
    # Ð¨Ð°Ð³ 2: ÐÐ°ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÑŒ Docker
    - name: Set up Docker
      uses: docker/setup-buildx-action@v3
      
    # Ð¨Ð°Ð³ 3: Ð—ÐÐ”ÐÐÐ˜Ð• 3 - Ð Ð°Ð·Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒ Ñ‡ÐµÑ€ÐµÐ· Docker Compose
    - name: Deploy with Docker Compose
      run: |
        echo "ðŸŽ¯ Ð’Ð«ÐŸÐžÐ›ÐÐ•ÐÐ˜Ð• Ð—ÐÐ”ÐÐÐ˜Ð¯ 3: Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ Ñ‡ÐµÑ€ÐµÐ· Docker Compose"
        echo "======================================================"
        
        # 1. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Docker Compose
        docker compose version
        
        # 2. ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ)
        echo "ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ñ… ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²..."
        docker compose down 2>/dev/null || true
        
        # 3. Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ñ‡ÐµÑ€ÐµÐ· Docker Compose
        echo "Ð—Ð°Ð¿ÑƒÑÐº docker compose up..."
        docker compose up -d --build --force-recreate
        
        # 4. Ð–Ð´ÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÐºÐ°
        echo "ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ° ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²..."
        sleep 15
        
        # 5. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚
        echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð½Ñ‹Ñ… ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²:"
        docker compose ps
        
        echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð»Ð¾Ð³Ð¾Ð²:"
        docker compose logs --tail=20
        
        # 6. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚ÑŒ
        echo "Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚Ð¸:"
        
        # Ð’ÐµÐ±-ÑÐµÑ€Ð²ÐµÑ€
        if curl -s -f http://localhost:8088 > /dev/null; then
          echo "âœ… Ð’ÐµÐ±-ÑÐ°Ð¹Ñ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ 8088"
          echo "Ð¡Ð°Ð¹Ñ‚: http://localhost:8088"
        else
          echo "âŒ Ð’ÐµÐ±-ÑÐ°Ð¹Ñ‚ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½"
          docker compose logs web
          exit 1
        fi
        
        # Adminer
        if curl -s -f http://localhost:8081 > /dev/null; then
          echo "âœ… Adminer Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ 8081"
          echo "Adminer: http://localhost:8081"
        else
          echo "âš ï¸ Adminer Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½"
        fi
        
        echo ""
        echo "======================================================"
        echo "âœ… Ð—ÐÐ”ÐÐÐ˜Ð• 3 Ð’Ð«ÐŸÐžÐ›ÐÐ•ÐÐž: ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ñ€Ð°Ð·Ð²ÐµÑ€Ð½ÑƒÑ‚Ð¾ Ñ‡ÐµÑ€ÐµÐ· Docker Compose!"
        echo ""
        echo "Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ ÑÐµÑ€Ð²Ð¸ÑÑ‹:"
        echo "  ðŸŒ Ð’ÐµÐ±-ÑÐ°Ð¹Ñ‚:    http://localhost:8088"
        echo "  ðŸ—„ï¸  Adminer:     http://localhost:8081"
        echo "  ðŸ”§ ÐšÐ¾Ð¼Ð°Ð½Ð´Ñ‹:     docker compose ps, docker compose logs"
        
    # Ð¨Ð°Ð³ 4: Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð¾Ñ‚Ñ‡ÐµÑ‚ Ð¾ Ð´ÐµÐ¿Ð»Ð¾Ðµ
    - name: Save deployment report
      run: |
        echo "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð° Ð¾ Ð´ÐµÐ¿Ð»Ð¾Ðµ..."
        DEPLOYMENT_TIME=$(date)
        cat > deploy-report.md << EOF
        # ÐžÑ‚Ñ‡ÐµÑ‚ Ð¾ Ð´ÐµÐ¿Ð»Ð¾Ðµ Ñ‡ÐµÑ€ÐµÐ· Docker Compose
        
        ## Ð”ÐµÑ‚Ð°Ð»Ð¸ Ð´ÐµÐ¿Ð»Ð¾Ñ
        - Ð”Ð°Ñ‚Ð° Ð¸ Ð²Ñ€ÐµÐ¼Ñ: $DEPLOYMENT_TIME
        - Ð’ÐµÑ‚ÐºÐ°: ${{ github.ref }}
        - ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚: ${{ github.sha }}
        
        ## Ð Ð°Ð·Ð²ÐµÑ€Ð½ÑƒÑ‚Ñ‹Ðµ ÑÐµÑ€Ð²Ð¸ÑÑ‹
        1. **web** (nginx) - Ð¿Ð¾Ñ€Ñ‚ 8088
        2. **database** (postgres) - Ð²Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÑÑ ÑÐµÑ‚ÑŒ
        3. **adminer** - Ð¿Ð¾Ñ€Ñ‚ 8081
        
        ## ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ¸
        - [x] Docker Compose Ñ„Ð°Ð¹Ð» Ð²Ð°Ð»Ð¸Ð´ÐµÐ½
        - [x] Ð’ÑÐµ ÑÐµÑ€Ð²Ð¸ÑÑ‹ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ñ‹
        - [x] Ð’ÐµÐ±-ÑÐ°Ð¹Ñ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½
        - [x] ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð¼ÑƒÐ»ÑŒÑ‚Ð¸ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð½Ð¾Ðµ
        
        ## ÐšÐ¾Ð¼Ð°Ð½Ð´Ñ‹ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ
        \`\`\`bash
        # ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ ÑÑ‚Ð°Ñ‚ÑƒÑÐ°
        docker compose ps
        
        # ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ Ð»Ð¾Ð³Ð¾Ð²
        docker compose logs
        
        # ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°
        docker compose down
        
        # ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº
        docker compose restart
        \`\`\`
        
        ## ÐÑ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð°
        \`\`\`
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚    Web      â”‚â”€â”€â”€â”€â–¶â”‚  Database   â”‚â—€â”€â”€â”€â”€â”‚   Adminer   â”‚
        â”‚  (nginx)    â”‚     â”‚ (postgres)  â”‚     â”‚             â”‚
        â”‚   :8088     â”‚     â”‚   :5432     â”‚     â”‚   :8081     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        \`\`\`
        EOF
        
        echo "ÐžÑ‚Ñ‡ÐµÑ‚ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½ Ð² deploy-report.md"
        
    # Ð¨Ð°Ð³ 5: Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
    - name: Notify success
      if: success()
      run: |
        echo "âœ… Ð”ÐµÐ¿Ð»Ð¾Ð¹ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½!"
        echo "ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ñ€Ð°Ð·Ð²ÐµÑ€Ð½ÑƒÑ‚Ð¾ Ñ‡ÐµÑ€ÐµÐ· Docker Compose"
        
  # Job 3: Health check (Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾)
  health-check:
    needs: deploy
    runs-on: ubuntu-latest
    
    steps:
    - name: Check application health
      run: |
        echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÑ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ..."
        
        # Ð”Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼Ñ Ð½Ð° Ð¿Ð¾Ð»Ð½Ñ‹Ð¹ Ð·Ð°Ð¿ÑƒÑÐº
        sleep 30
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð²ÑÐµ ÑÐµÑ€Ð²Ð¸ÑÑ‹
        echo "1. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²:"
        docker compose ps
        
        echo "2. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð²ÐµÐ±-ÑÐµÑ€Ð²ÐµÑ€Ð°:"
        curl -f http://localhost:8088 && echo "âœ“ Ð’ÐµÐ±-ÑÐµÑ€Ð²ÐµÑ€ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚"
        
        echo "3. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° volumes:"
        docker volume ls | grep postgres-data && echo "âœ“ Volume ÑÐ¾Ð·Ð´Ð°Ð½"
        
        echo ""
        echo "ðŸŽ‰ Ð’Ð¡Ð• ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ˜ ÐŸÐ ÐžÐ™Ð”Ð•ÐÐ«!"
        echo "Ð—Ð°Ð´Ð°Ð½Ð¸Ðµ 3 Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¾ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!"
