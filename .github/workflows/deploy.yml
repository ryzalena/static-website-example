name: CD Pipeline - Deploy with index.html

on:
  release:
    types: [published]
  # –¢–∞–∫–∂–µ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
  push:
    branches: [ main, github-actions ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Display index.html content
      run: |
        echo "=== –°–û–î–ï–†–ñ–ò–ú–û–ï index.html –ò–ó –†–ï–ü–û–ó–ò–¢–û–†–ò–Ø ==="
        echo ""
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ index.html
        if [ -f "index.html" ]; then
          echo "‚úÖ –§–∞–π–ª index.html –Ω–∞–π–¥–µ–Ω"
          echo "üìÑ –†–∞–∑–º–µ—Ä: $(stat -c%s index.html) –±–∞–π—Ç"
          echo "üïí –ü–æ—Å–ª–µ–¥–Ω–µ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ: $(stat -c%y index.html)"
          echo ""
          echo "üìã –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞:"
          echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
          cat index.html
          echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
        else
          echo "‚ùå –û–®–ò–ë–ö–ê: index.html –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∫–æ—Ä–Ω–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è!"
          echo "üìÅ –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –≤ –∫–æ—Ä–Ω–µ:"
          ls -la
          exit 1
        fi
    
    - name: Deploy files to VM
      uses: appleboy/scp-action@v0.1.7
      with:
        host: course.prafdin.ru
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 2200
        source: "index.html"
        target: "~/app/"
    
    - name: DEPLOY to VM
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: course.prafdin.ru
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 2200
        script: |
          echo "=== –ù–ê–ß–ê–õ–û –î–ï–ü–õ–û–Ø ==="
          echo "–í—Ä–µ–º—è: $(date)"
          echo ""
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª—Å—è
          if [ -f "~/app/index.html" ]; then
            echo "‚úÖ index.html —É—Å–ø–µ—à–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –Ω–∞ VM"
            echo ""
            echo "üìÑ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ index.html –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:"
            echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
            cat ~/app/index.html
            echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
          else
            echo "‚ùå –û–®–ò–ë–ö–ê: index.html –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
            exit 1
          fi
          
          echo ""
          echo "=== –ó–ê–ü–£–°–ö –°–ï–†–í–ï–†–ê ==="
          
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π —Å–µ—Ä–≤–µ—Ä –µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω
          pkill -f "http.server 8181" 2>/dev/null || true
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä
          cd ~/app
          python3 -m http.server 8181 --bind 0.0.0.0 > server.log 2>&1 &
          SERVER_PID=$!
          
          echo "‚úÖ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω (PID: $SERVER_PID)"
          echo "üåê –ü–æ—Ä—Ç: 8181"
          echo "üìù –õ–æ–≥–∏: ~/app/server.log"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç
          sleep 2
          if ps -p $SERVER_PID > /dev/null; then
            echo "‚úÖ –°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ"
          else
            echo "‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:"
            cat server.log
            exit 1
          fi
          
          echo ""
          echo "=== –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ò ==="
          echo "üîó URL: http://app.ryzhova.course.prafdin.ru"
          echo "üè∑Ô∏è  –ö–æ–º–º–∏—Ç: ${{ github.sha }}"
          echo "üìÇ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${{ github.repository }}"
          echo "üéØ –°–æ–±—ã—Ç–∏–µ: ${{ github.event_name }}"
