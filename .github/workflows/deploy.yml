name: Simple Deploy

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Deploy simple HTTP server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: course.prafdin.ru
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 2200
        script: |
          echo "–î–µ–ø–ª–æ–π –ø—Ä–æ—Å—Ç–æ–≥–æ HTTP —Å–µ—Ä–≤–µ—Ä–∞"
          
          # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π HTTP —Å–µ—Ä–≤–µ—Ä (–±–µ–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π)
          cat > /tmp/simple_server.py << 'END'
import http.server
import socketserver

PORT = 8181

class Handler(http.server.SimpleHTTPRequestHandler):
    def do_GET(self):
        self.send_response(200)
        self.send_header('Content-type', 'text/html')
        self.end_headers()
        self.wfile.write(b'GitHub Actions CD Pipeline - Lab 2 Success!')
    
    def log_message(self, format, *args):
        pass

print(f"Starting server on port {PORT}")
with socketserver.TCPServer(("", PORT), Handler) as httpd:
    httpd.serve_forever()
END
          
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä–æ–µ
          pkill -f "python3.*server" 2>/dev/null || true
          sleep 1
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤–æ–µ
          nohup python3 /tmp/simple_server.py > /tmp/server.log 2>&1 &
          SERVER_PID=$!
          
          echo "–°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω (PID: $SERVER_PID)"
          sleep 3
          
          # –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
          if curl -s http://localhost:8181 > /dev/null; then
            echo "–°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç"
            echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:"
            curl -s http://localhost:8181
          else
            echo "‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ä–≤–µ—Ä–æ–º"
          fi
          
          echo "üåê –î–æ—Å—Ç—É–ø–Ω–æ –ø–æ: http://app.ryzhova.course.prafdin.ru"
