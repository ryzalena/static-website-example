name: CD Pipeline - Debug Version

on:
  push:
    branches: [ main, github-actions ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Debug repository structure
      run: |
        echo "=== –î–ï–ë–ê–ì –†–ï–ü–û–ó–ò–¢–û–†–ò–Ø ==="
        echo "–†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
        echo ""
        echo "üìÅ –í—Å–µ —Ñ–∞–π–ª—ã:"
        ls -la
        echo ""
        echo "üîç –ü–æ–∏—Å–∫ HTML —Ñ–∞–π–ª–æ–≤:"
        find . -type f -name "*.html" -o -name "*.htm" | head -20
        echo ""
        echo "üå≥ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–∞—Ç–∞–ª–æ–≥–æ–≤:"
        find . -type d | sort
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ index.html
        if [ -f "index.html" ]; then
          echo "‚úÖ index.html –ù–ê–ô–î–ï–ù"
          echo "üìÑ –ü–µ—Ä–≤—ã–µ 20 —Å—Ç—Ä–æ–∫:"
          head -20 index.html
        else
          echo "‚ùå index.html –ù–ï –ù–ê–ô–î–ï–ù"
          # –ò—â–µ–º –ª—é–±–æ–π HTML —Ñ–∞–π–ª
          FIRST_HTML=$(find . -name "*.html" -type f | head -1)
          if [ -n "$FIRST_HTML" ]; then
            echo "üìÅ –ù–∞–π–¥–µ–Ω HTML —Ñ–∞–π–ª: $FIRST_HTML"
            echo "–°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ index.html..."
            cp "$FIRST_HTML" index.html
          fi
        fi
    
    - name: Prepare deployment files
      run: |
        # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –¥–µ–ø–ª–æ—è
        mkdir -p deploy
        cp -r ./* deploy/ 2>/dev/null || true
        cp -r .[!.]* deploy/ 2>/dev/null || true
        
        # –ï—Å–ª–∏ –Ω–µ—Ç index.html, —Å–æ–∑–¥–∞–µ–º –µ–≥–æ
        if [ ! -f "deploy/index.html" ]; then
          echo "–°–æ–∑–¥–∞—é index.html..."
          cat > deploy/index.html <<EOF
<!DOCTYPE html>
<html>
<head>
    <title>GitHub Actions Deploy</title>
    <meta charset="UTF-8">
</head>
<body>
    <h1>–†–∞–∑–≤–µ—Ä–Ω—É—Ç–æ —á–µ—Ä–µ–∑ GitHub Actions</h1>
    <p>–í—Ä–µ–º—è: $(date)</p>
    <p>–ö–æ–º–º–∏—Ç: ${{ github.sha }}</p>
    <p>–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${{ github.repository }}</p>
    <p>–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞. –î–æ–±–∞–≤—å—Ç–µ index.html –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π.</p>
</body>
</html>
EOF
        fi
        
        echo "–§–∞–π–ª—ã –¥–ª—è –¥–µ–ø–ª–æ—è:"
        ls -la deploy/
    
    - name: Copy files to VM
      uses: appleboy/scp-action@v0.1.7
      with:
        host: course.prafdin.ru
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 2200
        source: "deploy/"
        target: "~/app"
        rm: true  # –£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã
    
    - name: Deploy and verify
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: course.prafdin.ru
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 2200
        script: |
          echo "=== –ü–†–û–í–ï–†–ö–ê –ù–ê –°–ï–†–í–ï–†–ï ==="
          echo "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: ~/app"
          echo ""
          
          # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
          cd ~/app 2>/dev/null || mkdir -p ~/app && cd ~/app
          
          echo "üìÅ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:"
          ls -la
          echo ""
          
          if [ -f "index.html" ]; then
            echo "‚úÖ index.html –ù–ê–ô–î–ï–ù"
            echo "üìÑ –ü–µ—Ä–≤—ã–µ 15 —Å—Ç—Ä–æ–∫:"
            head -15 index.html
          else
            echo "‚ùå index.html –ù–ï –ù–ê–ô–î–ï–ù!"
            echo "–°–æ–∑–¥–∞—é index.html..."
            cat > index.html <<EOF
<!DOCTYPE html>
<html>
<head>
    <title>Deployed on Server</title>
</head>
<body>
    <h1>–°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç!</h1>
    <p>–í—Ä–µ–º—è: $(date)</p>
    <p>–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)</p>
    <p>–°–æ–∑–¥–∞–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ</p>
</body>
</html>
EOF
            echo "‚úÖ index.html —Å–æ–∑–¥–∞–Ω"
          fi
          
          echo ""
          echo "=== –ó–ê–ü–£–°–ö –°–ï–†–í–ï–†–ê ==="
          
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π —Å–µ—Ä–≤–µ—Ä
          pkill -f "http.server 8181" 2>/dev/null || echo "–°—Ç–∞—Ä—ã–π —Å–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω"
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π
          python3 -m http.server 8181 --bind 0.0.0.0 > server.log 2>&1 &
          SERVER_PID=$!
          
          sleep 1
          if kill -0 $SERVER_PID 2>/dev/null; then
            echo "‚úÖ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω (PID: $SERVER_PID)"
            echo "üåê –ü–æ—Ä—Ç: 8181"
            echo "üìù –õ–æ–≥–∏: ~/app/server.log"
          else
            echo "‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è"
            echo "–õ–æ–≥ —Å–µ—Ä–≤–µ—Ä–∞:"
            cat server.log 2>/dev/null || echo "–õ–æ–≥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
            exit 1
          fi
