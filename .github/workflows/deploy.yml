name: CD - Deploy with Docker Compose

on:
  push:
    branches: [ lab4 ]
  release:
    types: [ published ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    
    steps:
      - name: Show deployment info
        run: |
          echo "Ð—ÐÐ”ÐÐÐ˜Ð• 3 Ð›ÐÐ‘ÐžÐ ÐÐ¢ÐžÐ ÐÐžÐ™ â„–4"
          echo "=============================="
          echo "Ð¢Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸Ðµ: Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ Ñ‡ÐµÑ€ÐµÐ· Docker Compose"
          echo "Ð’ÐµÑ‚ÐºÐ°: ${{ github.ref }}"
          echo "ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚: ${{ github.sha }}"
          echo ""

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker Compose
        run: |
          echo "ðŸ”§ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Docker Compose..."
          docker compose version
          echo ""
          echo "ðŸ“„ Docker Compose Ñ„Ð°Ð¹Ð»:"
          if [ -f "docker-compose.yaml" ]; then
            cat docker-compose.yaml
          else
            echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: docker-compose.yaml Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!"
            exit 1
          fi

      - name: Ð—ÐÐ”ÐÐÐ˜Ð• 3 - Deploy with Docker Compose
        run: |
          echo "Ð’Ð«ÐŸÐžÐ›ÐÐ•ÐÐ˜Ð• Ð—ÐÐ”ÐÐÐ˜Ð¯ 3: docker compose up -d"
          echo "=============================================="
          
          # ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð° Ð·Ð°Ð´Ð°Ð½Ð¸Ñ 3
          docker compose up -d --build
          
          # Ð–Ð´ÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÐºÐ°
          sleep 20
          
          echo ""
          echo "ðŸ“Š Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ:"
          echo "-----------------------"
          docker compose ps
          
          echo ""
          echo "ðŸŒ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚Ð¸:"
          if curl -s -f http://localhost:8080 > /dev/null; then
            echo "âœ… Ð’ÐµÐ±-ÑÐµÑ€Ð²ÐµÑ€ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ 8080"
          else
            echo "âš ï¸ Ð’ÐµÐ±-ÑÐµÑ€Ð²ÐµÑ€ Ð½Ðµ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½, Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð»Ð¾Ð³Ð¸..."
            docker compose logs web
          fi
          
          echo ""
          echo "ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ñ€Ð°Ð·Ð²ÐµÑ€Ð½ÑƒÑ‚Ð¾ Ñ‡ÐµÑ€ÐµÐ· Docker Compose"

      - name: Save deployment report
        if: success()
        run: |
          cat > deployment-report.md << 'EOF'
          # ÐžÑ‚Ñ‡ÐµÑ‚ Ð¾ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ð¸ Ð»Ð°Ð±Ð¾Ñ€Ð°Ñ‚Ð¾Ñ€Ð½Ð¾Ð¹ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ â„–4
          
          ## Ð—Ð°Ð´Ð°Ð½Ð¸Ðµ 3: Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ Ñ‡ÐµÑ€ÐµÐ· Docker Compose
          
          **Ð¡Ñ‚Ð°Ñ‚ÑƒÑ:** âœ… Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¾
          
          **Ð’Ñ€ÐµÐ¼Ñ:** $(date)
          **Ð’ÐµÑ‚ÐºÐ°:** ${{ github.ref }}
          **ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚:** ${{ github.sha }}
          
          ### Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð½Ñ‹Ðµ Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸Ñ:
          1. âœ… ÐœÑƒÐ»ÑŒÑ‚Ð¸ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð½Ð¾Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
          2. âœ… ÐŸÐµÑ€ÑÐ¸ÑÑ‚ÐµÐ½Ñ‚Ð½Ñ‹Ð¹ ÑÐ»Ð¾Ð¹ (Ð±Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ…)
          3. âœ… Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ Ñ‡ÐµÑ€ÐµÐ· Docker Compose
          4. âœ… Docker volumes Ð´Ð»Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ…
          
          ### Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð½Ð°Ñ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð°:
          ```bash
          docker compose up -d --build
          ```
          
          ### Ð—Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð½Ñ‹Ðµ ÑÐµÑ€Ð²Ð¸ÑÑ‹:
          EOF
          
          docker compose ps --format "table {{.Name}}\t{{.Status}}\t{{.Ports}}" >> deployment-report.md
          
          echo ""
          echo "ðŸ“„ ÐžÑ‚Ñ‡ÐµÑ‚ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½: deployment-report.md"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: lab4-deployment
          path: |
            deployment-report.md
            docker-compose.yaml

      - name: Cleanup
        if: always()
        run: |
          echo "ðŸ§¹ ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ..."
          docker compose down 2>/dev/null || true
