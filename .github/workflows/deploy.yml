name: Deploy with Docker Compose

on:
  push:
    branches: [ lab4, main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    # Ð¨Ð°Ð³ 1: ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÐºÐ¾Ð´ (Ð’Ð¡Ð• Ñ„Ð°Ð¹Ð»Ñ‹ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ)
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð²ÑÑŽ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ
        
    # Ð¨Ð°Ð³ 2: ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Ñ„Ð°Ð¹Ð»Ð¾Ð² (Ð´Ð»Ñ Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ¸)
    - name: List files
      run: |
        echo "ðŸ“ Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ:"
        ls -la
        echo ""
        echo "ðŸ“„ ÐŸÐ¾Ð¸ÑÐº docker-compose Ñ„Ð°Ð¹Ð»Ð¾Ð²:"
        find . -name "*.yml" -o -name "*.yaml" | sort
        echo ""
        echo "ðŸ“‚ Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°:"
        tree -I '.git|node_modules' || find . -type f | head -20
        
    # Ð¨Ð°Ð³ 3: ÐÐ°ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÑŒ Docker
    - name: Set up Docker
      uses: docker/setup-buildx-action@v3
      
    # Ð¨Ð°Ð³ 4: ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Docker Compose
    - name: Check Docker Compose
      run: |
        echo "ðŸ”§ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Docker Compose:"
        docker compose version
        echo ""
        echo "ðŸ“‹ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸:"
        # Ð£Ð±ÐµÐ´Ð¸Ð¼ÑÑ, Ñ‡Ñ‚Ð¾ Ñ„Ð°Ð¹Ð» ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
        if [ -f "docker-compose.yaml" ]; then
          echo "âœ… docker-compose.yaml Ð½Ð°Ð¹Ð´ÐµÐ½"
          cat docker-compose.yaml | head -20
        elif [ -f "docker-compose.yml" ]; then
          echo "âœ… docker-compose.yml Ð½Ð°Ð¹Ð´ÐµÐ½"
          cat docker-compose.yml | head -20
        else
          echo "âŒ Ð¤Ð°Ð¹Ð» docker-compose Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!"
          exit 1
        fi
        
    # Ð¨Ð°Ð³ 5: Ð—ÐÐ”ÐÐÐ˜Ð• 3 - Ð Ð°Ð·Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒ Ñ‡ÐµÑ€ÐµÐ· Docker Compose
    - name: Deploy with Docker Compose
      run: |
        echo "ðŸŽ¯ Ð’Ð«ÐŸÐžÐ›ÐÐ•ÐÐ˜Ð• Ð—ÐÐ”ÐÐÐ˜Ð¯ 3: Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ Ñ‡ÐµÑ€ÐµÐ· Docker Compose"
        echo "======================================================"
        
        # 1. Ð¡Ð¾Ð·Ð´Ð°Ð´Ð¸Ð¼ Ð½ÐµÐ´Ð¾ÑÑ‚Ð°ÑŽÑ‰Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ñ‹, ÐµÑÐ»Ð¸ Ð¸Ñ… Ð½ÐµÑ‚
        echo "ðŸ”§ ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° Ñ„Ð°Ð¹Ð»Ð¾Ð²..."
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¸ ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ docker-compose.yaml ÐµÑÐ»Ð¸ ÐµÐ³Ð¾ Ð½ÐµÑ‚
        if [ ! -f "docker-compose.yaml" ] && [ ! -f "docker-compose.yml" ]; then
          echo "Ð¡Ð¾Ð·Ð´Ð°ÑŽ docker-compose.yaml..."
          cat > docker-compose.yaml << 'DOCKERCOMPOSE'
services:
  web:
    image: nginx:alpine
    container_name: static-website-nginx
    ports:
      - "8080:80"
    volumes:
      - ./public:/usr/share/nginx/html:ro
    networks:
      - website-network
    restart: unless-stopped

  database:
    image: postgres:15-alpine
    container_name: website-postgres
    environment:
      POSTGRES_USER: website_admin
      POSTGRES_PASSWORD: secure_password_123
      POSTGRES_DB: website_stats
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - website-network
    restart: unless-stopped

volumes:
  postgres-data:

networks:
  website-network:
DOCKERCOMPOSE
        fi
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð°Ð¿ÐºÑƒ public ÐµÑÐ»Ð¸ ÐµÑ‘ Ð½ÐµÑ‚
        mkdir -p public
        if [ ! -f "public/index.html" ]; then
          echo "Ð¡Ð¾Ð·Ð´Ð°ÑŽ index.html..."
          cat > public/index.html << 'HTML'
<!DOCTYPE html>
<html>
<head>
    <title>Docker Compose Lab</title>
</head>
<body>
    <h1>Lab 4: Docker Compose</h1>
    <p>Multicontainer application deployed via GitHub Actions</p>
</body>
</html>
HTML
        fi
        
        # 2. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ
        echo "âœ… ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° docker-compose.yaml:"
        docker compose config
        
        # 3. Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
        echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº docker compose up..."
        docker compose up -d --build
        
        # 4. Ð–Ð´ÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÐºÐ°
        echo "â³ ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ° ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²..."
        sleep 15
        
        # 5. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚
        echo "ðŸ“Š ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð½Ñ‹Ñ… ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²:"
        docker compose ps
        
        echo "ðŸ“ Ð›Ð¾Ð³Ð¸ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 10 ÑÑ‚Ñ€Ð¾Ðº:"
        docker compose logs --tail=10
        
        # 6. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚ÑŒ
        echo "ðŸŒ Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚Ð¸:"
        
        # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¿Ð¾Ñ€Ñ‚ Ð¸Ð· ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
        PORT=8080
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð²ÐµÐ±-ÑÐµÑ€Ð²ÐµÑ€
        if curl -s -f -o /dev/null -w "HTTP: %{http_code}\n" http://localhost:$PORT; then
          echo "âœ… Ð’ÐµÐ±-ÑÐ°Ð¹Ñ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ $PORT"
          echo "ðŸŒ Ð¡Ð°Ð¹Ñ‚: http://localhost:$PORT"
        else
          echo "âŒ Ð’ÐµÐ±-ÑÐ°Ð¹Ñ‚ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ $PORT"
          echo "ðŸ” Ð›Ð¾Ð³Ð¸ Ð²ÐµÐ±-ÑÐµÑ€Ð²ÐµÑ€Ð°:"
          docker compose logs web
          # ÐÐµ Ð²Ñ‹Ñ…Ð¾Ð´Ð¸Ð¼ Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ¾Ð¹, Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð°ÐµÐ¼
        fi
        
        echo ""
        echo "======================================================"
        echo "âœ… Ð—ÐÐ”ÐÐÐ˜Ð• 3 Ð’Ð«ÐŸÐžÐ›ÐÐ•ÐÐž: ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ñ€Ð°Ð·Ð²ÐµÑ€Ð½ÑƒÑ‚Ð¾ Ñ‡ÐµÑ€ÐµÐ· Docker Compose!"
        echo ""
        echo "ðŸ“‹ Ð¡Ð²Ð¾Ð´ÐºÐ°:"
        echo "  ÐšÐ¾Ð¼Ð°Ð½Ð´Ð°: docker compose up -d"
        echo "  Ð¡ÐµÑ€Ð²Ð¸ÑÑ‹: $(docker compose ps --services | wc -l) Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð¾"
        echo "  Ð¡Ñ‚Ð°Ñ‚ÑƒÑ: $(docker compose ps --format 'table {{.Name}}\t{{.Status}}')"
        
    # Ð¨Ð°Ð³ 6: Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ‹ (Ð»Ð¾Ð³Ð¸)
    - name: Save logs
      if: always()
      run: |
        echo "ðŸ’¾ Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð»Ð¾Ð³Ð¾Ð²..."
        mkdir -p artifacts
        docker compose ps > artifacts/containers.txt
        docker compose logs > artifacts/all-logs.txt 2>/dev/null || true
        docker compose logs web > artifacts/web-logs.txt 2>/dev/null || true
        
    - name: Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: docker-compose-logs
        path: artifacts/
        
    # Ð¨Ð°Ð³ 7: ÐžÑ‡Ð¸ÑÑ‚ÐºÐ°
    - name: Cleanup
      if: always()
      run: |
        echo "ðŸ§¹ ÐžÑ‡Ð¸ÑÑ‚ÐºÐ°..."
        docker compose down -v 2>/dev/null || true
