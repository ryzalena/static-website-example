name: CD - Deploy to Production

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy to VM via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: course.prafdin.ru
          port: 2200
          username: vboxuser
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "Starting deployment at $(date)"
            echo "================================="
            
            # Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ Ñ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸ÐµÐ¼ Ð½Ð° Ð’Ðœ
            APP_DIR="$HOME/static-website-example"
            
            echo "Target directory: $APP_DIR"
            
            # ÐŸÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
            cd "$APP_DIR" || exit 1
            
            # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ
            echo "Pulling latest changes..."
            git fetch origin
            git checkout github-actions
            git pull origin github-actions
            
            echo "Code updated successfully"
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ñ„Ð°Ð¹Ð»Ñ‹ Ð½Ð° Ð¼ÐµÑÑ‚Ðµ
            echo "ðŸ” Checking deployed files:"
            ls -la index.html css/ || true
            
            # ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Nginx
            echo "Restarting Nginx..."
            sudo systemctl restart nginx
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ Nginx
            echo "Nginx status:"
            sudo systemctl status nginx --no-pager
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚ÑŒ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
            echo "Checking application availability..."
            sleep 3
            
            if curl -f http://localhost:8181 > /dev/null 2>&1; then
              echo "Application is running and accessible!"
              echo "Public URL: http://app.Ð²Ð°Ñˆ_ID.course.prafdin.ru"
            else
              echo "Warning: Could not connect to application"
              echo "Trying to check logs..."
              sudo tail -20 /var/log/nginx/error.log || true
            fi
            
            echo "================================="
            echo "Deployment completed at $(date)"
