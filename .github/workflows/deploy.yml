name: CD Pipeline

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Deploy via SSH
      uses: appleboy/ssh-action@v1.0.3
      env:
        SSH_USER: ${{ secrets.SSH_USER }}
        SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      with:
        host: course.prafdin.ru
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 2200
        script: |
          echo "Starting deployment..."
          
          # Подготовка
          mkdir -p ~/app
          cd ~/app
          
          # Создаем минимальное приложение
          echo 'from flask import Flask
          app = Flask(__name__)
          
          @app.route("/")
          def hello():
              return "<h1>GitHub Actions CD</h1><p>Student: Ryzhova</p>"
          
          if __name__ == "__main__":
              app.run(host="0.0.0.0", port=8181)' > app.py
          
          # Устанавливаем Flask
          pip3 install --break-system-packages flask
          
          # Запускаем
          nohup python3 app.py > ~/app.log 2>&1 &
          
          echo "Deployment completed"
          echo "Check: http://app.ryzhova.course.prafdin.ru"
