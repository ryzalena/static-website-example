name: CD - Deploy to Production

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy to VM via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: course.prafdin.ru
          port: 2200
          username: vboxuser
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "ğŸš€ Starting deployment at $(date)"
            echo "================================="
            
            # Ğ”Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ñ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸ĞµĞ¼ Ğ½Ğ° Ğ’Ğœ
            APP_DIR="$HOME/static-website-example"
            
            echo "ğŸ“‚ Target directory: $APP_DIR"
            
            # ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ² Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
            cd "$APP_DIR" || exit 1
            
            # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ
            echo "ğŸ”„ Pulling latest changes..."
            git fetch origin
            git checkout github-actions
            git pull origin github-actions
            
            echo "âœ… Code updated successfully"
            
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ½Ğ° Ğ¼ĞµÑÑ‚Ğµ
            echo "ğŸ” Checking deployed files:"
            ls -la index.html css/ || true
            
            # ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Nginx
            echo "ğŸ”„ Restarting Nginx..."
            sudo systemctl restart nginx
            
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ Nginx
            echo "ğŸ“Š Nginx status:"
            sudo systemctl status nginx --no-pager
            
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
            echo "ğŸŒ Checking application availability..."
            sleep 3
            
            if curl -f http://localhost:8181 > /dev/null 2>&1; then
              echo "âœ… Application is running and accessible!"
              echo "ğŸŒ Public URL: http://app.Ğ²Ğ°Ñˆ_ID.course.prafdin.ru"
            else
              echo "âš ï¸  Warning: Could not connect to application"
              echo "Trying to check logs..."
              sudo tail -20 /var/log/nginx/error.log || true
            fi
            
            echo "================================="
            echo "ğŸ‰ Deployment completed at $(date)"
