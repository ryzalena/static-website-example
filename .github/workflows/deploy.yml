script: |
  echo "Начало деплоя..."
  
  # Переходим в директорию
  mkdir -p ~/app
  cd ~/app
  
  # Создаем простое Flask приложение
  cat > app.py << 'EOF'
from flask import Flask
app = Flask(__name__)

@app.route('/')
def hello():
    return 'Лабораторная работа №2 - GitHub Actions успешно работает!'

@app.route('/health')
def health():
    return 'OK', 200

if __name__ == '__main__':
    print("Запуск приложения на порту 8181...")
    app.run(host='0.0.0.0', port=8181, debug=False)
EOF
  
  # Устанавливаем Flask
  echo "Устанавливаем Flask..."
  pip3 install --break-system-packages flask
  
  # Останавливаем старое приложение
  echo "Останавливаем старое приложение..."
  pkill -f "python3.*app.py" 2>/dev/null || true
  sleep 2
  
  # Запускаем новое с подробным логированием
  echo "Запускаем новое приложение..."
  
  # Запускаем в фоне с логированием
  python3 app.py > ~/app_output.log 2>&1 &
  APP_PID=$!
  
  echo "PID: $APP_PID"
  echo $APP_PID > ~/app.pid
  
  # Ждем и проверяем
  sleep 5
  
  echo "Проверка состояния приложения..."
  
  # 1. Проверяем процесс
  if ps -p $APP_PID > /dev/null; then
    echo "Процесс работает"
  else
    echo "Процесс завершился"
    echo "Логи:"
    cat ~/app_output.log
    exit 1
  fi
  
  # 2. Проверяем порт локально
  echo "Проверяем порт 8181 локально..."
  if curl -s -f --max-time 5 http://localhost:8181 > /dev/null; then
    echo "Локальная проверка пройдена"
    echo "Ответ приложения:"
    curl -s http://localhost:8181
  else
    echo "Локальная проверка не пройдена"
    echo "Проверяем логи:"
    tail -20 ~/app_output.log
  fi
  
  # 3. Проверяем через FRP
  echo "Проверяем через FRP..."
  APP_URL="http://app.ryzhova.course.prafdin.ru"
  
  for i in {1..3}; do
    echo "Попытка $i/3..."
    if curl -s -f --max-time 10 "$APP_URL" > /dev/null; then
      echo "Успешно! Приложение доступно по: $APP_URL"
      exit 0
    fi
    sleep 3
  done
  
  echo "Не удалось подключиться через FRP"
  echo "Приложение может быть запущено локально, но не доступно извне"
  echo "Проверьте конфигурацию FRP"
  exit 0  # Не падаем, даже если FRP не работает
