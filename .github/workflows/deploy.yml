name: CD - Deploy to Production

on:
  # –ó–∞–ø—É—Å–∫ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–µ–ª–∏–∑–∞
  release:
    types: [published]
  
  # –î–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –∏–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ GitHub
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      # –®–∞–≥ 1: –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.target_commitish || github.ref }}
      
      # –®–∞–≥ 2: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å SSH –∫–ª—é—á –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ VM
      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      # –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ VM
      - name: Test SSH connection
        run: |
          ssh -o StrictHostKeyChecking=no -p 2200 \
          ${{ secrets.SSH_USER }}@course.prafdin.ru \
          "echo 'SSH connection successful!'"
      
      # –®–∞–≥ 4: –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ VM
      - name: Deploy application
        run: |
          # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
          VM_USER=${{ secrets.SSH_USER }}
          VM_HOST="course.prafdin.ru"
          VM_PORT="2200"
          APP_DIR="/var/www/static-website"  # –ò–∑–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à –ø—É—Ç—å
          DOMAIN="app.ryzhova.course.prafdin.ru"
          
          # SSH –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
          ssh -o StrictHostKeyChecking=no -p $VM_PORT $VM_USER@$VM_HOST << 'DEPLOY_EOF'
            set -e  # –í—ã–π—Ç–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ
            
            echo "=== Starting deployment ==="
            echo "Deployment time: $(date)"
            
            # 1. –ü–µ—Ä–µ–π—Ç–∏ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –µ—ë
            if [ ! -d "$APP_DIR" ]; then
              echo "Creating application directory..."
              sudo mkdir -p $APP_DIR
              sudo chown $USER:$USER $APP_DIR
            fi
            
            cd $APP_DIR
            
            # 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å git –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            if [ ! -d ".git" ]; then
              echo "Initializing git repository..."
              git init
              git remote add origin https://github.com/ryzalena/static-website-example.git || true
            fi
            
            # 3. –ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
            echo "Pulling latest code..."
            git fetch origin
            git checkout github-actions --force
            git reset --hard origin/github-actions
            git clean -fd
            
            # 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞
            echo "Project structure:"
            ls -la
            
            # 5. –ï—Å–ª–∏ —ç—Ç–æ Python –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            if [ -f "requirements.txt" ]; then
              echo "Installing Python dependencies..."
              pip3 install -r requirements.txt
            fi
            
            # 6. –ï—Å–ª–∏ —ç—Ç–æ Node.js –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            if [ -f "package.json" ]; then
              echo "Installing Node.js dependencies..."
              npm install
              npm run build || true
            fi
            
            # 7. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –≤–µ–±-—Å–µ—Ä–≤–µ—Ä (–ø—Ä–∏–º–µ—Ä –¥–ª—è nginx + —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–∞–π—Ç–∞)
            echo "Configuring web server..."
            
            # –°–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥ nginx –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            NGINX_CONF="/etc/nginx/sites-available/$DOMAIN"
            if [ ! -f "$NGINX_CONF" ]; then
              echo "Creating nginx configuration..."
              sudo tee $NGINX_CONF > /dev/null << NGINX_EOF
            server {
                listen 80;
                server_name $DOMAIN;
                
                root $APP_DIR;
                index index.html index.htm;
                
                location / {
                    try_files \$uri \$uri/ =404;
                }
            }
            NGINX_EOF
            
              # –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å–∞–π—Ç
              sudo ln -sf $NGINX_CONF /etc/nginx/sites-enabled/
              sudo nginx -t && sudo systemctl reload nginxfi
            
            # 8. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ –Ω–∞ –ø–æ—Ä—Ç—É 8181
            # –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å nginx –Ω–∞ –ø–æ—Ä—Ç 8181:
            echo "Checking application on port 8181..."
            
            # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ä—ã–π –ø—Ä–æ—Ü–µ—Å—Å –µ—Å–ª–∏ –µ—Å—Ç—å
            pkill -f "python.*8181" || true
            pkill -f "node.*8181" || true
            
            # –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–ø—Ä–∏–º–µ—Ä –¥–ª—è Python)
            if [ -f "app.py" ] || [ -f "main.py" ]; then
              echo "Starting Python application..."
              nohup python3 -m http.server 8181 --directory ./ > app.log 2>&1 &
            elif [ -f "index.html" ]; then
              echo "Starting static web server..."
              nohup python3 -m http.server 8181 --directory ./ > app.log 2>&1 &
            fi
            
            # 9. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—Å—Ç–∏–ª–æ—Å—å
            sleep 2
            if curl -s http://localhost:8181 > /dev/null; then
              echo "‚úÖ Application is running on port 8181"
            else
              echo "‚ùå Application failed to start on port 8181"
              exit 1
            fi
            
            # 10. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ FRP –¥–æ–º–µ–Ω
            echo "Checking external accessibility..."
            echo "Your app should be available at: http://$DOMAIN"
            
            echo "=== Deployment completed successfully! ==="
          DEPLOY_EOF
      
      # –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
      - name: Verify deployment
        run: |
          sleep 5  # –î–∞—Ç—å –≤—Ä–µ–º—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è
          
          echo "Testing application accessibility..."
          if curl -s -f http://app.ryzhova.course.prafdin.ru > /dev/null; then
            echo "‚úÖ SUCCESS: Application is accessible at http://app.ryzhova.course.prafdin.ru"
          else
            echo "‚ö†Ô∏è  WARNING: Application might not be accessible externally"
            echo "Check FRP configuration and nginx"
          fi
          
      # –®–∞–≥ 6: –£–≤–µ–¥–æ–º–∏—Ç—å –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
      - name: Deployment notification
        if: success()
        run: |
          echo "üöÄ Deployment completed successfully!"
          echo "Application URL: http://app.ryzhova.course.prafdin.ru"
          echo "GitHub Release: ${{ github.event.release.html_url || 'Manual deployment' }}"
