name: Docker Compose Deploy

on:
  push:
    branches: [ lab4 ]

jobs:
  test-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Debug - Show files
      run: |
        echo "Current directory: $(pwd)"
        echo "Files:"
        ls -la
        echo "Looking for compose files:"
        find . -type f -name "*compose*"
        
    - name: Create docker-compose if missing
      run: |
        # Если файла нет - создаем минимальный
        if [ ! -f "docker-compose.yaml" ]; then
          echo "Creating minimal docker-compose.yaml..."
          cat > docker-compose.yaml << 'EOF'
version: '3.8'
services:
  web:
    image: nginx:alpine
    ports:
      - "80:80"
EOF
        fi
        
        # Создаем простой сайт
        mkdir -p public
        echo "<h1>Docker Compose Test</h1>" > public/index.html
        
    - name: Deploy with Compose
      run: |
        echo "Deploying with Docker Compose..."
        docker compose up -d
        sleep 5
        docker compose ps
        echo "✅ Deployment complete!"
