name: CD Pipeline - Deploy to VM

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Deploy to VM
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: course.prafdin.ru
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 2200
        script: |
          echo "Начало деплоя приложения..."
          
          # Создаем и переходим в директорию
          mkdir -p ~/app
          cd ~/app
          
          # Останавливаем старое приложение
          echo "Останавливаем старое приложение..."
          pkill -f "python3.*app.py" 2>/dev/null || true
          sleep 2
          
          # Создаем Flask приложение
          echo "from flask import Flask" > app.py
          echo "app = Flask(__name__)" >> app.py
          echo "" >> app.py
          echo "@app.route('/')" >> app.py
          echo "def index():" >> app.py
          echo "    return 'Лабораторная работа №2 - GitHub Actions успешно работает!'" >> app.py
          echo "" >> app.py
          echo "@app.route('/health')" >> app.py
          echo "def health():" >> app.py
          echo "    return 'OK', 200" >> app.py
          echo "" >> app.py
          echo "if __name__ == '__main__':" >> app.py
          echo "    app.run(host='0.0.0.0', port=8181)" >> app.py
          
          echo "Создан app.py"
          
          # Проверяем наличие requirements.txt, если нет - создаем
          if [ ! -f "requirements.txt" ]; then
            echo "Flask==2.3.3" > requirements.txt
            echo "Создан requirements.txt"
          fi
          
          # Устанавливаем зависимости из requirements.txt
          echo "Устанавливаем зависимости..."
          pip3 install --break-system-packages -r requirements.txt 2>&1 | grep -E "(Successfully|Installing|error)"
          
          # Запускаем приложение
          echo "Запускаем приложение..."
          nohup python3 app.py > app.log 2>&1 &
          APP_PID=$!
          echo $APP_PID > app.pid
          
          echo "PID приложения: $APP_PID"
          
          # Ждем запуска
          sleep 5
          
          # Проверяем запуск
          echo "Проверяем состояние приложения..."
          if ps -p $APP_PID > /dev/null; then
            echo "Приложение запущено успешно"
            echo "Логи (последние 5 строк):"
            tail -5 app.log
          else
            echo "Приложение не запустилось"
            echo "Полные логи:"
            cat app.log
            exit 1
          fi
          
          # Локальная проверка
          echo "Локальная проверка..."
          if curl -s -f --max-time 5 http://localhost:8181 > /dev/null; then
            echo "Локально приложение отвечает"
            echo "Содержимое:"
            curl -s http://localhost:8181
          else
            echo "Не удалось подключиться локально"
          fi
          
          echo "Внешний URL: http://app.ryzhova.course.prafdin.ru"
          echo "Деплой завершен!"
    
    - name: Verify deployment
      run: |
        echo "Проверка деплоя..."
        APP_URL="http://app.ryzhova.course.prafdin.ru"
        
        sleep 10
        
        for i in {1..5}; do
          echo "Попытка подключения $i/5..."
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$APP_URL" || echo "000")
          
          if [ "$STATUS" = "200" ]; then
            echo "Успех! HTTP статус: $STATUS"
            echo "Содержимое страницы:"
            curl -s "$APP_URL" | head -3
            exit 0
          fi
          
          echo "Статус: $STATUS, ждем 3 секунды..."
          sleep 3
        done
        
        echo "Не удалось подключиться к приложению за 25 секунд"
        echo "Проверьте вручную: $APP_URL"
        exit 0
