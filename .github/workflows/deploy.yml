name: CD Pipeline

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code from GitHub
      uses: actions/checkout@v4  # ← ЗАГРУЖАЕТ код из репозитория
    
    - name: Copy files to VM
      uses: appleboy/scp-action@v0.1.7  # ← КОПИРУЕТ на VM
      with:
        host: course.prafdin.ru
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 2200
        source: "index.html app.py requirements.txt"  # ← Файлы из репозитория
        target: "/home/${{ secrets.SSH_USER }}/app/"
    
    - name: Deploy application
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: course.prafdin.ru
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 2200
        script: |
          cd ~/app
          # Устанавливаем зависимости из репозитория
          pip3 install --break-system-packages -r requirements.txt
          # Запускаем приложение ИЗ репозитория
          pkill -f "python3.*app.py" 2>/dev/null || true
          nohup python3 app.py &
