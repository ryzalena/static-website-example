name: CD - Docker Deploy

on:
  release:
    types: [published]  # Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ñ€Ð¸ Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ†Ð¸Ð¸ Ñ€ÐµÐ»Ð¸Ð·Ð°
  workflow_run:
    workflows: ["CI - Docker Static Site"]  # Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ð¾ÑÐ»Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð³Ð¾ CI
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event_name == 'release' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Extract release tag
        id: get_tag
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            echo "TAG=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          else
            # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ñ‚ÐµÐ³ Ð¸Ð· CI workflow
            echo "TAG=latest" >> $GITHUB_OUTPUT
          fi
          echo "Using tag: ${{ steps.get_tag.outputs.TAG }}"
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      - name: Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p 2200 course.prafdin.ru >> ~/.ssh/known_hosts
      
      - name: Deploy Docker container to server
        run: |
          ssh -p 2200 ryzhova@course.prafdin.ru << 'EOF'
            echo "ðŸš€ Starting Docker deployment..."
            
            # 1. Ð›Ð¾Ð³Ð¸Ð½Ð¸Ð¼ÑÑ Ð² GitHub Container Registry
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # 2. ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¸ ÑƒÐ´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ð¹ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ)
            docker stop static-site-container 2>/dev/null || true
            docker rm static-site-container 2>/dev/null || true
            
            # 3. ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ñ‚ÐµÐ³ Ð´Ð»Ñ Ð¾Ð±Ñ€Ð°Ð·Ð°
            RELEASE_TAG="${{ steps.get_tag.outputs.TAG }}"
            IMAGE_NAME="ghcr.io/${{ github.repository_owner }}/static-site:$RELEASE_TAG"
            
            echo "ðŸ“¦ Pulling image: $IMAGE_NAME"
            
            # 4. Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¾Ð±Ñ€Ð°Ð· Ð¸Ð· registry
            docker pull $IMAGE_NAME
            
            # 5. Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ñ Ð¿Ñ€Ð¾Ð±Ñ€Ð¾ÑÐ¾Ð¼ Ð¿Ð¾Ñ€Ñ‚Ð¾Ð²
            echo "ðŸ³ Starting container..."
            docker run -d \
              --name static-site-container \
              --restart unless-stopped \
              -p 80:80 \
              -p 443:443 \
              $IMAGE_NAME
            
            # 6. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ð»ÑÑ
            sleep 3
            CONTAINER_STATUS=$(docker inspect -f '{{.State.Status}}' static-site-container 2>/dev/null || echo "not_found")
            
            if [ "$CONTAINER_STATUS" = "running" ]; then
              echo "âœ… Container is running with status: $CONTAINER_STATUS"
              
              # 7. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚ÑŒ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
              echo "ðŸ” Testing application..."
              if curl -s -f http://localhost > /dev/null; then
                echo "âœ… Application is accessible at http://localhost"
                echo "ðŸŒ Public URL: http://app.ryzhova.course.prafdin.ru"
              else
                echo "âš ï¸  Application check failed, checking logs..."
                docker logs static-site-container --tail 20
              fi
            else
              echo "âŒ Container failed to start. Status: $CONTAINER_STATUS"
              docker logs static-site-container --tail 30
              exit 1
            fi
            
            # 8. ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÑÑ‚Ð°Ñ€Ñ‹Ñ… Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð² (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
            echo "ðŸ§¹ Cleaning up unused Docker resources..."
            docker system prune -f 2>/dev/null || true
            
            echo "ðŸŽ‰ Deployment completed successfully!"
          EOF
