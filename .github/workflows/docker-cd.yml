name: CD - Deploy Docker Static Site

on:
  release:
    types: [ published ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    
    steps:
      - name: Show release info
        run: |
          echo "ðŸš€ Docker deployment for static site"
          echo "Release: ${{ github.event.release.tag_name }}"
          echo "Repository: ${{ github.repository }}"
          echo "Actor: ${{ github.actor }}"

      - name: Deploy over SSH (Docker)
        uses: appleboy/ssh-action@v1
        with:
          host: course.prafdin.ru  # Ð¸Ð»Ð¸ ${{ secrets.SSH_HOST }}
          port: 2200               # Ð²Ð°Ñˆ SSH Ð¿Ð¾Ñ€Ñ‚
          username: ryzhova        # Ð²Ð°Ñˆ SSH Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "=== Docker deployment for ryzalena/static-site ==="
            
            # 1. Ð›Ð¾Ð³Ð¸Ð½Ð¸Ð¼ÑÑ Ð² GHCR
            echo "Logging in to GitHub Container Registry..."
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin
            
            # 2. ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ñ‚ÐµÐ³ Ð¾Ð±Ñ€Ð°Ð·Ð°
            if [ -n "${{ github.event.release.tag_name }}" ]; then
              IMAGE_TAG="${{ github.event.release.tag_name }}"
            else
              IMAGE_TAG="latest"
            fi
            
            IMAGE_NAME="ghcr.io/ryzalena/static-site:$IMAGE_TAG"
            echo "Using image: $IMAGE_NAME"
            
            # 3. ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ð¹ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€
            echo "Stopping old container..."
            docker stop static-site-container 2>/dev/null || true
            docker rm static-site-container 2>/dev/null || true
            
            # 4. Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ Ð¾Ð±Ñ€Ð°Ð·
            echo "Pulling new image..."
            docker pull "$IMAGE_NAME"
            
            # 5. Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€
            echo "Starting new container..."
            docker run -d \
              --name static-site-container \
              --restart unless-stopped \
              -p 80:80 \
              "$IMAGE_NAME"
            
            # 6. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÐº
            echo "Checking container status..."
            sleep 3
            docker ps | grep static-site-container
            
            # 7. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚ÑŒ
            echo "Testing application..."
            if curl -s -f http://localhost > /dev/null; then
              echo "âœ… Application is running"
              echo "ðŸŒ Available at: http://app.ryzhova.course.prafdin.ru"
            else
              echo "âŒ Application check failed"
              docker logs static-site-container --tail 20
              exit 1
            fi
            
            # 8. ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÑÑ‚Ð°Ñ€Ñ‹Ñ… Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð²
            echo "Cleaning up..."
            docker system prune -f 2>/dev/null || true
            
            echo "ðŸŽ‰ Deployment completed successfully!"
