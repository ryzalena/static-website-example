name: Deploy to Production

on:
  release:
    types: [published]  # Запускается сразу при публикации релиза

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Extract release tag
        id: get_tag
        run: echo "TAG=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 2200
          script: |
            # Логинимся в GHCR
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # Останавливаем старый контейнер
            docker stop static-site-prod 2>/dev/null || true
            docker rm static-site-prod 2>/dev/null || true
            
            # Запускаем новый с тегом релиза
            RELEASE_TAG="${{ steps.get_tag.outputs.TAG }}"
            echo "Deploying version: $RELEASE_TAG"
            
            docker pull ghcr.io/${{ github.repository_owner }}/static-site:$RELEASE_TAG
            docker run -d \
              --name static-site-prod \
              --restart unless-stopped \
              -p 80:80 \
              ghcr.io/${{ github.repository_owner }}/static-site:$RELEASE_TAG
            
            # Проверяем
            sleep 3
            curl -f http://localhost || exit 1
            echo "Deployment of $RELEASE_TAG completed successfully."
