name: CD Deploy

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Log in to GitHub Container Registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p 2200 course.prafdin.ru >> ~/.ssh/known_hosts

      - name: Deploy on server
        run: |
          ssh -p 2200 ryzhova@course.prafdin.ru << 'EOF'
            # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–≥ —Ä–µ–ª–∏–∑–∞
            RELEASE_TAG="${{ github.event.release.tag_name }}"
            echo "üöÄ Starting deployment of version: $RELEASE_TAG"
            
            # –õ–æ–≥–∏–Ω–∏–º—Å—è –≤ GHCR
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            docker stop static-site-prod 2>/dev/null || true
            docker rm static-site-prod 2>/dev/null || true
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å —Ç–µ–≥–æ–º —Ä–µ–ª–∏–∑–∞
            docker run -d \
              --name static-site-prod \
              --restart unless-stopped \
              -p 80:80 \
              ghcr.io/${{ github.repository_owner }}/static-site:$RELEASE_TAG
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å
            sleep 5
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost)
            echo "üì° HTTP Status: $HTTP_STATUS"
            
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "‚úÖ Deployment successful! App is available at: http://app.${{ secrets.SSH_USER }}.course.prafdin.ru"
            else
              echo "‚ùå Deployment failed! HTTP Status: $HTTP_STATUS"
              exit 1
            fi
          EOF
