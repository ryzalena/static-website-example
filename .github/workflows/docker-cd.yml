name: CD - Deploy Docker Static Site

on:
  release:
    types: [ published ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    
    steps:
      - name: Show release info
        run: |
          echo "üöÄ Docker deployment for static site"
          echo "Release: ${{ github.event.release.tag_name }}"
          echo "Repository: ${{ github.repository }}"
          echo "Actor: ${{ github.actor }}"

      - name: Deploy over SSH (Docker)
        uses: appleboy/ssh-action@v1
        with:
          host: course.prafdin.ru  # –∏–ª–∏ ${{ secrets.SSH_HOST }}
          port: 2200               # –≤–∞—à SSH –ø–æ—Ä—Ç
          username: styzhev        # –≤–∞—à SSH –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "=== Lab 3: Docker Deployment ==="
            echo "Pulling image from GitHub Container Registry..."
          
            # –õ–æ–≥–∏–Ω–∏–º—Å—è –≤ GitHub Container Registry
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
            # –¢—è–Ω–µ–º –æ–±—Ä–∞–∑
            docker pull ghcr.io/${{ github.repository }}:docker-lab3
          
            echo "Stopping old container..."
            docker stop static-site-container || true
            docker rm static-site-container || true
          
            echo "Starting new container..."
            docker run -d \
              --name static-site-container \
              --restart unless-stopped \
              -p 8181:80 \
               ghcr.io/ryzalena/static-site:latest
          
            sleep 5
            echo "‚úÖ Docker container deployed from registry!"
            echo "üì° Application: http://app.ryzhova.course.prafdin.ru"
            echo ""
            echo "üìä Architecture:"
            echo "- CI: builds and pushes to GHCR"
            echo "- CD: pulls from GHCR and deploys"
