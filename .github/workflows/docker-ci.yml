name: CI - Docker Static Site

on:
  push:
    branches: [labs3]
  pull_request:
    branches: [labs3]

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check HTML structure
        run: |
          echo "Checking static website structure..."
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã
          REQUIRED_FILES=("index.html" "style.css" "script.js" "Dockerfile")
          
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "ERROR: Required file $file not found!"
              exit 1
            else
              echo "‚úì Found: $file"
            fi
          done
          
          # –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ HTML
          if grep -qi "<!DOCTYPE html>" index.html; then
            echo "‚úì HTML doctype found"
          else
            echo "Warning: HTML doctype not found in index.html"
          fi
          
          echo "‚úÖ Static files validation passed!"
      
      - name: Check file sizes
        run: |
          echo "üìä File sizes:"
          find . -type f \( -name "*.html" -o -name "*.css" -o -name "*.js" -o -name "Dockerfile" \) -exec ls -lh {} \;

  # –ù–û–í–´–ô JOB: Docker —Å–±–æ—Ä–∫–∞ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
  docker-build-test:
    needs: validate
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # –ó–∞–¥–∞–Ω–∏–µ 4: –õ–∏–Ω—Ç–∏–Ω–≥ Dockerfile (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
      - name: Lint Dockerfile with Hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: ./Dockerfile
        continue-on-error: true  # –ù–µ –∑–∞–≤–µ—Ä—à–∞—Ç—å –ø–∞–π–ø–ª–∞–π–Ω –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –ª–∏–Ω—Ç–∏–Ω–≥–∞
      
      # –ó–∞–¥–∞–Ω–∏–µ 4: –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞
      - name: Build Docker image
        run: |
          echo "Building Docker image..."
          docker build -t static-site:local .
          echo "‚úÖ Docker image built successfully"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ–±—Ä–∞–∑ —Å–æ–∑–¥–∞–Ω
          docker images | grep static-site
      
      # –ó–∞–¥–∞–Ω–∏–µ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ (–≤ CI)
      - name: Test Docker container locally
        run: |
          echo "Testing Docker container..."
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
          docker run -d --name test-static-site -p 8080:80 static-site:local
          
          # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
          sleep 5
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω
          docker ps | grep test-static-site
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
          echo "Testing application availability..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080)
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "‚úÖ Application is accessible (HTTP $HTTP_CODE)"
            
            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
            if curl -s http://localhost:8080 | grep -q "html"; then
              echo "‚úÖ HTML content detected"
            fi
          else
            echo "‚ùå Application not accessible (HTTP $HTTP_CODE)"
            docker logs test-static-site
            exit 1
          fi
          
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
          docker stop test-static-site
          docker rm test-static-site
      
      # –ó–∞–¥–∞–Ω–∏–µ 4: –ü—É–±–ª–∏–∫–∞—Ü–∏—è –≤ GitHub Container Registry
      - name: Login to GitHub Container Registry
        if: github.event_name != 'pull_request'  # –¢–æ–ª—å–∫–æ –¥–ª—è push, –Ω–µ –¥–ª—è PR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Tag and push Docker image
        if: github.event_name != 'pull_request'
        run: |
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–≥–∏
          IMAGE_NAME="ghcr.io/${{ github.repository_owner }}/static-site"
          
          # –î–ª—è main –≤–µ—Ç–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º latest
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            TAGS="$IMAGE_NAME:latest $IMAGE_NAME:${{ github.sha }}"
          else
            # –î–ª—è labs3 –≤–µ—Ç–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º labs3 —Ç–µ–≥
            TAGS="$IMAGE_NAME:labs3 $IMAGE_NAME:${{ github.sha }}"
          fi
          
          echo "Tags: $TAGS"
          
          # –¢—ç–≥–∏—Ä—É–µ–º –∏ –ø—É—à–∏–º
          for TAG in $TAGS; do
            docker tag static-site:local $TAG
            docker push $TAG
            echo "‚úÖ Pushed: $TAG"
          done
      
      # –ó–∞–¥–∞–Ω–∏–µ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –æ–±—Ä–∞–∑ –¥–æ—Å—Ç—É–ø–µ–Ω –≤ registry
      - name: Verify image in registry
        if: github.event_name != 'pull_request'
        run: |
          IMAGE_NAME="ghcr.io/${{ github.repository_owner }}/static-site"
          
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            TAG="latest"
          else
            TAG="labs3"
          fi
          
          echo "Verifying image: $IMAGE_NAME:$TAG"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ–±—Ä–∞–∑ –¥–æ—Å—Ç—É–ø–µ–Ω (–±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö)
          curl -s -f "https://ghcr.io/v2/${{ github.repository_owner }}/static-site/manifests/$TAG" > /dev/null && \
            echo "‚úÖ Image available in registry" || \
            echo "‚ö†Ô∏è  Image may be private or not accessible"
